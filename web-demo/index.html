<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boule P√©tanque Training App</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2E7D32">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Boule Training">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            max-width: 480px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2E7D32 0%, #1B5E20 100%);
            color: white;
            padding: 44px 20px 18px;
            text-align: center;
        }
        .header h1 { font-size: 22px; margin-bottom: 2px; }
        .header p { font-size: 13px; opacity: 0.9; }

        /* Nav */
        .nav { display: flex; background: white; border-bottom: 1px solid #e0e0e0; position: sticky; top: 0; z-index: 100; }
        .nav-btn {
            flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px;
            padding: 10px 4px; border: none; background: none; cursor: pointer;
            border-bottom: 3px solid transparent; transition: all 0.2s; font-size: 11px; font-weight: 500; color: #666;
        }
        .nav-btn.active { border-bottom-color: #2E7D32; color: #2E7D32; }
        .nav-btn span:first-child { font-size: 18px; }

        /* Content */
        .content { padding: 16px; padding-bottom: 32px; }
        .tab { display: none; animation: fadeIn 0.3s ease; }
        .tab.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .stat {
            background: linear-gradient(135deg, #2E7D32 0%, #1B5E20 100%);
            color: white; padding: 18px; border-radius: 14px; text-align: center;
        }
        .stat-val { font-size: 28px; font-weight: bold; margin-bottom: 2px; }
        .stat-lbl { font-size: 11px; opacity: 0.9; }

        /* Streak */
        .streak {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white; padding: 14px; border-radius: 14px;
            display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 16px;
        }
        .streak-fire { font-size: 26px; }
        .streak-num { font-size: 28px; font-weight: bold; }
        .streak-txt { font-size: 13px; opacity: 0.9; }

        /* Level */
        .level {
            background: white; border-radius: 14px; padding: 14px; margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .level-row { display: flex; justify-content: space-between; font-size: 13px; font-weight: 600; margin-bottom: 6px; }
        .progress { height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #2E7D32, #4CAF50); border-radius: 4px; transition: width 0.4s; }

        /* Cards */
        .card {
            background: white; border-radius: 14px; padding: 16px; margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .card-row { display: flex; justify-content: space-between; align-items: center; font-size: 13px; margin-bottom: 4px; }
        .badge { padding: 2px 10px; border-radius: 10px; font-size: 11px; font-weight: 600; }
        .badge-green { background: #E8F5E9; color: #2E7D32; }
        .badge-red { background: #FFEBEE; color: #D32F2F; }

        /* Section title */
        .section-title { font-size: 16px; font-weight: 600; margin: 18px 0 10px; color: #333; }

        /* Throw types */
        .throw-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
        .throw-card {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            padding: 16px 8px; background: white; border: 2px solid #e0e0e0;
            border-radius: 12px; cursor: pointer; transition: all 0.2s; font-size: 13px; font-weight: 600;
        }
        .throw-card:hover { border-color: #4CAF50; }
        .throw-card.selected { border-color: #2E7D32; background: #E8F5E9; }
        .throw-card span:first-child { font-size: 28px; }

        /* Result */
        .result {
            background: white; border-radius: 14px; padding: 20px; margin-bottom: 14px;
            text-align: center; box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }
        .result-acc { font-size: 48px; font-weight: bold; margin-bottom: 6px; }
        .result-details { display: flex; justify-content: center; gap: 20px; font-size: 13px; color: #666; margin-bottom: 10px; }
        .result-bar { height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; }
        .result-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }

        /* Session summary */
        .summary {
            background: white; border-radius: 12px; padding: 10px 14px;
            display: flex; justify-content: space-between; font-size: 13px; font-weight: 600;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04); margin-bottom: 10px;
        }

        /* Scoreboard */
        .scoreboard { display: flex; align-items: stretch; margin-bottom: 14px; }
        .score-side {
            flex: 1; background: white; border-radius: 14px; padding: 18px; text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); display: flex; flex-direction: column; align-items: center; gap: 6px;
        }
        .score-label { font-size: 13px; font-weight: 600; }
        .score-num { font-size: 44px; font-weight: bold; color: #2E7D32; }
        .score-num.opp { color: #D32F2F; }
        .score-vs { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0 10px; }
        .score-vs span:first-child { font-size: 18px; font-weight: bold; color: #888; }
        .score-vs span:last-child { font-size: 10px; color: #aaa; margin-top: 2px; }
        .score-btn {
            padding: 8px 18px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold;
            cursor: pointer; color: white; transition: all 0.2s;
        }
        .score-btn.p { background: #2E7D32; }
        .score-btn.o { background: #D32F2F; }
        .score-btn:hover { transform: scale(1.05); }

        /* Challenges */
        .challenge {
            background: white; border-radius: 12px; padding: 14px; margin-bottom: 10px;
            border-left: 4px solid #2E7D32; box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        }
        .challenge-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .challenge-title { font-size: 14px; font-weight: 600; }
        .challenge-reward { background: #FFF3E0; color: #F57C00; padding: 2px 10px; border-radius: 10px; font-size: 11px; font-weight: 600; }
        .challenge-desc { font-size: 12px; color: #888; margin-bottom: 8px; }
        .challenge-prog { font-size: 11px; color: #888; text-align: right; margin-top: 4px; }
        .challenge-prog .done { color: #2E7D32; font-weight: 600; }

        /* Achievements */
        .ach-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .ach {
            background: white; border-radius: 12px; padding: 14px; text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06); transition: transform 0.2s;
        }
        .ach:hover { transform: translateY(-2px); }
        .ach.locked { opacity: 0.35; filter: grayscale(80%); }
        .ach-icon { font-size: 36px; margin-bottom: 4px; }
        .ach-name { font-size: 12px; font-weight: 600; margin-bottom: 2px; }
        .ach-pts { font-size: 11px; color: #2E7D32; font-weight: 600; }

        /* Buttons */
        .btn {
            display: block; width: 100%; padding: 14px; border: none; border-radius: 12px;
            font-size: 15px; font-weight: 600; cursor: pointer; margin-top: 10px; transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-go {
            background: linear-gradient(135deg, #2E7D32 0%, #1B5E20 100%); color: white;
            box-shadow: 0 4px 12px rgba(46,125,50,0.3);
        }
        .btn-go:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(46,125,50,0.4); }
        .btn-go:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
        .btn-stop {
            background: white; color: #D32F2F; border: 2px solid #D32F2F;
        }
        .btn-stop:hover { background: #FFEBEE; }

        /* Notification */
        .notif {
            position: fixed; top: 14px; left: 50%; transform: translateX(-50%);
            background: #2E7D32; color: white; padding: 10px 22px; border-radius: 10px;
            font-size: 13px; font-weight: 600; z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); animation: slideD 0.3s ease;
            max-width: 90%; text-align: center; display: none;
        }
        @keyframes slideD { from { opacity: 0; transform: translateX(-50%) translateY(-20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }

        /* Empty */
        .empty { text-align: center; padding: 28px 16px; color: #888; font-size: 14px; }

        /* Install banner */
        .install-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 12px 20px; text-align: center; font-size: 13px;
            cursor: pointer; display: none;
        }
        .install-banner strong { font-weight: 700; }
    </style>
</head>
<body>

<div class="notif" id="notif"></div>

<div class="install-banner" id="install-banner" onclick="installApp()">
    <strong>Installera appen</strong> ‚Äì L√§gg till p√• hemsk√§rmen
</div>

<header class="header">
    <h1>üéØ Boule P√©tanque</h1>
    <p>AI-Powered Training App</p>
</header>

<nav class="nav" id="nav">
    <button class="nav-btn active" data-tab="home"><span>üè†</span><span>Hem</span></button>
    <button class="nav-btn" data-tab="training"><span>üéØ</span><span>Tr√§ning</span></button>
    <button class="nav-btn" data-tab="game"><span>üèÜ</span><span>Spel</span></button>
    <button class="nav-btn" data-tab="challenges"><span>üéÆ</span><span>Utmaningar</span></button>
    <button class="nav-btn" data-tab="achievements"><span>‚≠ê</span><span>Achievements</span></button>
</nav>

<main class="content">
    <!-- HOME -->
    <div class="tab active" id="tab-home"></div>

    <!-- TRAINING -->
    <div class="tab" id="tab-training"></div>

    <!-- GAME -->
    <div class="tab" id="tab-game"></div>

    <!-- CHALLENGES -->
    <div class="tab" id="tab-challenges"></div>

    <!-- ACHIEVEMENTS -->
    <div class="tab" id="tab-achievements"></div>
</main>

<script>
(function() {
    /* ‚îÄ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ */
    var LS = 'boule_';
    function load(key, def) { try { var d = localStorage.getItem(LS+key); return d ? JSON.parse(d) : def; } catch(e) { return def; } }
    function save(key, val) { localStorage.setItem(LS+key, JSON.stringify(val)); }

    var stats = load('stats2', { accuracy: 0, totalThrows: 0, totalSessions: 0, wins: 0, streak: 0, lastTrainingDate: null, level: 1, points: 0, ptnl: 500 });
    var sessions = load('sessions2', []);
    var games = load('games2', []);
    var achievements = load('ach2', [
        { id:'first_throw', name:'F√∂rsta Kastet', icon:'üéØ', pts:10, unlocked:false, req:'G√∂r ditt f√∂rsta kast' },
        { id:'dedicated', name:'Dedikerad Tr√§nare', icon:'üí™', pts:100, unlocked:false, req:'10 tr√§ningspass' },
        { id:'first_win', name:'F√∂rsta Segern', icon:'üèÜ', pts:50, unlocked:false, req:'Vinn ett spel' },
        { id:'week_warrior', name:'Veckokrigar', icon:'üî•', pts:150, unlocked:false, req:'7 dagars streak' },
        { id:'champion', name:'Champion', icon:'üëë', pts:500, unlocked:false, req:'N√• level 10' },
        { id:'precision', name:'Precisionsm√§stare', icon:'üéñÔ∏è', pts:1000, unlocked:false, req:'90% noggrannhet' },
        { id:'century', name:'100 Kast', icon:'üíØ', pts:200, unlocked:false, req:'100 totala kast' },
    ]);

    // Training state
    var throwType = null, isTraining = false, throwResult = null, sessionThrows = [];
    // Game state
    var gameActive = false, gameScore = { p: 0, o: 0 }, gameTarget = 13;

    /* ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ */
    function notify(msg) {
        var el = document.getElementById('notif');
        el.textContent = msg; el.style.display = 'block';
        setTimeout(function() { el.style.display = 'none'; }, 3000);
    }

    function updateStreak() {
        var today = new Date().toDateString();
        if (stats.lastTrainingDate === today) return;
        var y = new Date(); y.setDate(y.getDate()-1);
        stats.streak = (stats.lastTrainingDate === y.toDateString()) ? stats.streak + 1 : 1;
        stats.lastTrainingDate = today;
    }

    function checkAch() {
        var checks = [
            ['first_throw', stats.totalThrows >= 1],
            ['dedicated', stats.totalSessions >= 10],
            ['first_win', stats.wins >= 1],
            ['week_warrior', stats.streak >= 7],
            ['champion', stats.level >= 10],
            ['precision', stats.accuracy >= 90],
            ['century', stats.totalThrows >= 100],
        ];
        checks.forEach(function(c) {
            var a = achievements.find(function(x) { return x.id === c[0]; });
            if (a && !a.unlocked && c[1]) {
                a.unlocked = true;
                stats.points += a.pts;
                notify('Achievement: ' + a.icon + ' ' + a.name + ' (+' + a.pts + 'p)');
            }
        });
        while (stats.points >= stats.ptnl) {
            stats.level += 1;
            stats.points -= stats.ptnl;
            stats.ptnl = Math.floor(stats.ptnl * 1.3);
            notify('Level Up! Du √§r nu Level ' + stats.level);
        }
        save('ach2', achievements);
        save('stats2', stats);
    }

    function accColor(v) { return v >= 80 ? '#2E7D32' : v >= 60 ? '#F57C00' : '#D32F2F'; }

    /* ‚îÄ‚îÄ‚îÄ TAB SWITCHING ‚îÄ‚îÄ‚îÄ */
    var navBtns = document.querySelectorAll('.nav-btn');
    navBtns.forEach(function(btn) {
        btn.addEventListener('click', function() {
            navBtns.forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
            render();
        });
    });

    /* ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ */
    function render() {
        renderHome();
        renderTraining();
        renderGame();
        renderChallenges();
        renderAchievements();
    }

    function renderHome() {
        var h = '';
        h += '<div class="stats-grid">';
        h += '<div class="stat"><div class="stat-val">' + stats.accuracy + '%</div><div class="stat-lbl">Noggrannhet</div></div>';
        h += '<div class="stat"><div class="stat-val">' + stats.totalSessions + '</div><div class="stat-lbl">Tr√§ningspass</div></div>';
        h += '<div class="stat"><div class="stat-val">' + stats.wins + '</div><div class="stat-lbl">Vinster</div></div>';
        h += '<div class="stat"><div class="stat-val">' + stats.totalThrows + '</div><div class="stat-lbl">Totalt kast</div></div>';
        h += '</div>';
        if (stats.streak > 0) {
            h += '<div class="streak"><span class="streak-fire">üî•</span><span class="streak-num">' + stats.streak + '</span><span class="streak-txt">dagars streak</span></div>';
        }
        h += '<div class="level"><div class="level-row"><span>‚≠ê Level ' + stats.level + '</span><span>' + stats.points + ' / ' + stats.ptnl + ' p</span></div>';
        h += '<div class="progress"><div class="progress-fill" style="width:' + (stats.points/stats.ptnl*100) + '%"></div></div></div>';
        h += '<div class="section-title">Senaste tr√§ningspass</div>';
        if (sessions.length === 0) {
            h += '<div class="empty">Inga tr√§ningspass √§nnu. Starta din f√∂rsta tr√§ning!</div>';
        } else {
            sessions.slice(0, 5).forEach(function(s) {
                h += '<div class="card"><div class="card-row"><span style="font-weight:600">' + new Date(s.date).toLocaleDateString('sv-SE') + '</span><span class="badge badge-green">' + s.throws + ' kast</span></div>';
                h += '<div class="card-row"><span>Noggrannhet: ' + s.accuracy + '%</span><span style="color:#888;font-size:11px;text-transform:capitalize">' + s.type + '</span></div></div>';
            });
        }
        document.getElementById('tab-home').innerHTML = h;
    }

    function renderTraining() {
        var h = '';
        if (!isTraining) {
            h += '<div class="section-title">V√§lj kasttyp</div>';
            h += '<div class="throw-grid">';
            var types = [['pointing','Pointing','üéØ'],['shooting','Shooting','üí•'],['rolling','Rolling','üé±'],['lob','Lob','üåà']];
            types.forEach(function(t) {
                h += '<div class="throw-card' + (throwType===t[0]?' selected':'') + '" onclick="app.selectThrow(\'' + t[0] + '\')">';
                h += '<span>' + t[2] + '</span><span>' + t[1] + '</span></div>';
            });
            h += '</div>';
            h += '<button class="btn btn-go" onclick="app.startTraining()"' + (throwType?'':' disabled') + '>Starta Tr√§ning</button>';
        } else {
            h += '<div class="card-row" style="margin-bottom:14px"><span style="font-weight:600">Tr√§nar: ' + throwType + '</span><span class="badge badge-green">' + sessionThrows.length + ' kast</span></div>';
            if (throwResult) {
                var c = accColor(throwResult.accuracy);
                h += '<div class="result"><div class="result-acc" style="color:' + c + '">' + throwResult.accuracy + '%</div>';
                h += '<div class="result-details"><span>Avst√•nd: ' + throwResult.distance + 'm</span><span>Hastighet: ' + throwResult.speed + ' km/h</span></div>';
                h += '<div class="result-bar"><div class="result-fill" style="width:' + throwResult.accuracy + '%;background:' + c + '"></div></div></div>';
            }
            h += '<button class="btn btn-go" onclick="app.doThrow()">üéØ Kasta!</button>';
            if (sessionThrows.length > 0) {
                var avg = Math.round(sessionThrows.reduce(function(s,t){return s+t.accuracy;},0)/sessionThrows.length);
                var best = Math.max.apply(null, sessionThrows.map(function(t){return t.accuracy;}));
                h += '<div class="summary"><span>Snitt: ' + avg + '%</span><span>B√§sta: ' + best + '%</span></div>';
            }
            h += '<button class="btn btn-stop" onclick="app.endSession()">Avsluta Pass</button>';
        }
        document.getElementById('tab-training').innerHTML = h;
    }

    function renderGame() {
        var h = '';
        if (!gameActive) {
            h += '<div class="section-title">Nytt Spel</div>';
            h += '<div class="card"><p style="font-size:13px;color:#666;margin-bottom:12px">Spela till ' + gameTarget + ' po√§ng. Registrera po√§ng efter varje omg√•ng.</p>';
            h += '<button class="btn btn-go" onclick="app.startGame()">Starta Spel</button></div>';
            h += '<div class="section-title">Spelhistorik</div>';
            if (games.length === 0) {
                h += '<div class="empty">Inga spel √§nnu.</div>';
            } else {
                games.slice(0,10).forEach(function(g) {
                    h += '<div class="card"><div class="card-row"><span>' + new Date(g.date).toLocaleDateString('sv-SE') + '</span>';
                    h += '<span class="badge ' + (g.won?'badge-green':'badge-red') + '">' + (g.won?'Vinst':'F√∂rlust') + '</span></div>';
                    h += '<div class="card-row"><span>Du ' + g.ps + ' ‚Äì ' + g.os + ' Motst√•ndare</span></div></div>';
                });
            }
        } else {
            h += '<div class="scoreboard">';
            h += '<div class="score-side"><div class="score-label">Du</div><div class="score-num">' + gameScore.p + '</div>';
            h += '<button class="score-btn p" onclick="app.addPt(\'p\')">+1</button></div>';
            h += '<div class="score-vs"><span>VS</span><span>F√∂rst till ' + gameTarget + '</span></div>';
            h += '<div class="score-side"><div class="score-label">Motst√•ndare</div><div class="score-num opp">' + gameScore.o + '</div>';
            h += '<button class="score-btn o" onclick="app.addPt(\'o\')">+1</button></div>';
            h += '</div>';
            h += '<button class="btn btn-stop" onclick="app.cancelGame()">Avbryt Spel</button>';
        }
        document.getElementById('tab-game').innerHTML = h;
    }

    function renderChallenges() {
        var chs = [
            { icon:'üéØ', title:'Precision Master', desc:'G√∂r 10 kast med √∂ver 80% noggrannhet', target:10, reward:50 },
            { icon:'‚ö°', title:'Speed Demon', desc:'Slutf√∂r ett tr√§ningspass p√• under 15 min', target:1, reward:30 },
            { icon:'üèÜ', title:'Champion', desc:'Vinn 3 matcher', target:3, reward:100 },
        ];
        var prog = load('chprog', [0,0,0]);
        var h = '<div class="streak" style="flex-direction:column;padding:22px"><span style="font-size:44px">üî•</span><span class="streak-num">' + stats.streak + '</span><span class="streak-txt">Dagars Streak</span></div>';
        h += '<div class="section-title">Dagens Utmaningar</div>';
        chs.forEach(function(c, i) {
            var p = Math.min(prog[i], c.target);
            var pct = (p/c.target*100);
            h += '<div class="challenge"><div class="challenge-head"><span class="challenge-title">' + c.icon + ' ' + c.title + '</span>';
            h += '<span class="challenge-reward">+' + c.reward + 'p</span></div>';
            h += '<div class="challenge-desc">' + c.desc + '</div>';
            h += '<div class="progress"><div class="progress-fill" style="width:' + pct + '%"></div></div>';
            h += '<div class="challenge-prog">' + (p>=c.target?'<span class="done">‚úì Klar!</span>':p+'/'+c.target) + '</div></div>';
        });
        document.getElementById('tab-challenges').innerHTML = h;
    }

    function renderAchievements() {
        var h = '<div class="card" style="background:linear-gradient(135deg,#2E7D32,#1B5E20);color:white;text-align:center;padding:22px">';
        h += '<div style="font-size:44px;margin-bottom:6px">‚≠ê</div>';
        h += '<div style="font-size:26px;font-weight:bold">Level ' + stats.level + '</div>';
        h += '<div style="font-size:14px;opacity:0.9;margin-bottom:10px">' + stats.points + ' po√§ng</div>';
        h += '<div class="progress" style="background:rgba(255,255,255,0.3)"><div class="progress-fill" style="width:' + (stats.points/stats.ptnl*100) + '%;background:white"></div></div>';
        h += '<div style="font-size:11px;margin-top:6px;opacity:0.85">' + (stats.ptnl-stats.points) + ' po√§ng till Level ' + (stats.level+1) + '</div></div>';
        h += '<div class="section-title">Dina Achievements</div><div class="ach-grid">';
        achievements.forEach(function(a) {
            h += '<div class="ach' + (a.unlocked?'':' locked') + '"><div class="ach-icon">' + a.icon + '</div>';
            h += '<div class="ach-name">' + a.name + '</div><div class="ach-pts">+' + a.pts + 'p</div></div>';
        });
        h += '</div>';
        document.getElementById('tab-achievements').innerHTML = h;
    }

    /* ‚îÄ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ‚îÄ */
    window.app = {
        selectThrow: function(type) {
            throwType = type;
            renderTraining();
        },
        startTraining: function() {
            if (!throwType) return;
            isTraining = true; sessionThrows = []; throwResult = null;
            renderTraining();
        },
        doThrow: function() {
            var accuracy = Math.floor(Math.random()*40)+60;
            var distance = (Math.random()*2).toFixed(2);
            var speed = (Math.random()*15+5).toFixed(1);
            throwResult = { accuracy: accuracy, distance: distance, speed: speed };
            sessionThrows.push(throwResult);

            stats.totalThrows += 1;
            var allAcc = sessionThrows.reduce(function(s,t){return s+t.accuracy;},0);
            stats.accuracy = Math.round(allAcc / sessionThrows.length);
            updateStreak();
            checkAch();

            // Challenge progress
            if (accuracy >= 80) {
                var prog = load('chprog', [0,0,0]);
                prog[0] = Math.min(prog[0]+1, 10);
                save('chprog', prog);
                if (prog[0] === 10) notify('Utmaning klar: Precision Master (+50p)');
            }

            save('stats2', stats);
            renderTraining();
        },
        endSession: function() {
            if (sessionThrows.length > 0) {
                var avg = Math.round(sessionThrows.reduce(function(s,t){return s+t.accuracy;},0)/sessionThrows.length);
                sessions.unshift({ date: new Date().toISOString(), throws: sessionThrows.length, accuracy: avg, type: throwType });
                save('sessions2', sessions);
                stats.totalSessions += 1;
                checkAch();
                save('stats2', stats);
                // Speed demon challenge
                var prog = load('chprog', [0,0,0]);
                prog[1] = Math.min(prog[1]+1, 1);
                save('chprog', prog);
                notify('Tr√§ningspass sparat! ' + sessionThrows.length + ' kast, ' + avg + '% snitt');
            }
            isTraining = false; throwResult = null; sessionThrows = []; throwType = null;
            render();
        },
        startGame: function() {
            gameActive = true; gameScore = { p:0, o:0 };
            renderGame();
        },
        addPt: function(who) {
            gameScore[who] += 1;
            if (gameScore.p >= gameTarget || gameScore.o >= gameTarget) {
                var won = gameScore.p >= gameTarget;
                if (won) stats.wins += 1;
                checkAch();
                games.unshift({ date: new Date().toISOString(), ps: gameScore.p, os: gameScore.o, won: won });
                save('games2', games); save('stats2', stats);
                // Champion challenge
                if (won) { var prog = load('chprog',[0,0,0]); prog[2] = Math.min(prog[2]+1,3); save('chprog',prog); }
                notify(won ? 'Grattis! Du vann!' : 'Tyv√§rr, f√∂rlust. N√§sta g√•ng!');
                gameActive = false; gameScore = { p:0, o:0 };
            }
            renderGame();
        },
        cancelGame: function() {
            gameActive = false; gameScore = { p:0, o:0 };
            renderGame();
        }
    };

    // Initial render
    render();

    /* ‚îÄ‚îÄ‚îÄ PWA ‚îÄ‚îÄ‚îÄ */
    var deferredPrompt;
    window.addEventListener('beforeinstallprompt', function(e) {
        e.preventDefault(); deferredPrompt = e;
        var b = document.getElementById('install-banner');
        if (b) b.style.display = 'block';
    });
    window.installApp = function() {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(function() {
            deferredPrompt = null;
            var b = document.getElementById('install-banner');
            if (b) b.style.display = 'none';
        });
    };
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
})();
</script>
</body>
</html>
